<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>CBT Exam â€” ATech ICT Solution</title>
<meta name="theme-color" content="#16A34A" />
<link rel="icon" href="data:," />
<style>
  /* Mobile-first green theme */
  :root{
    --bg:#f0fdf4; --card:#ffffff; --accent:#16A34A; --muted:#4b5563; --warn:#f59e0b; --danger:#dc2626;
    --soft:#ecfdf0;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial;color:#0f172a;background:var(--bg);-webkit-font-smoothing:antialiased}
  .wrap{max-width:760px;margin:14px auto;padding:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(6,95,70,0.06);overflow:hidden}
  .header{display:flex;justify-content:space-between;align-items:center;padding:16px 16px;background:linear-gradient(90deg,#ecfdf5,#f0fdf4)}
  .title{font-weight:700;font-size:18px}
  .sub{font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:0}
  .container{padding:16px}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6f4ea;margin-top:10px;font-size:16px}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 6px 18px rgba(22,163,74,0.12)}
  button[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:12px;align-items:center}
  .videoWrap{width:100%;display:flex;justify-content:center;margin-top:12px}
  video{width:320px;height:240px;border-radius:12px;border:4px solid rgba(22,163,74,0.12);background:#000;object-fit:cover}
  .status{margin-top:8px;font-weight:700}
  .warning{color:var(--warn);font-weight:800;margin-top:6px}
  .flag{color:var(--danger);font-weight:900;margin-top:6px}
  .qbox{margin-top:14px;padding:14px;border-radius:12px;background:var(--soft)}
  .opts label{display:block;margin:8px 0;padding:8px;border-radius:10px;border:1px solid #e6f4ea;cursor:pointer}
  .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .timer{font-weight:800;color:#064e3b}
  .resultBox{padding:12px;background:#ecfdf4;border-radius:10px;margin-top:12px}
  .footer{padding:12px;text-align:center;font-size:13px;color:var(--muted);background:#ffffff;border-top:1px solid #eefaf0}
  .help{background:#25D366;color:white;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700}
  @media(max-width:420px){
    video{width:280px;height:200px}
    .title{font-size:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">CBT Exam â€” ATech ICT Solution</div>
          <div class="sub">Mobile-only â€¢ 20 questions â€¢ 20 minutes â€¢ Live camera monitoring</div>
        </div>
        <div><a class="help" href="https://wa.me/2348145415083" target="_blank" rel="noopener">Help / Support</a></div>
      </div>

      <div class="container">
        <!-- Welcome -->
        <div id="step-welcome">
          <label class="muted">Enter your full name</label>
          <input id="name" placeholder="Your full name" type="text" />
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="proceedBtn">Proceed</button>
            <div class="muted">You will be asked to allow camera access</div>
          </div>
        </div>

        <!-- Face capture -->
        <div id="step-capture" style="display:none">
          <h3 style="margin:12px 0 6px 0">Face verification (capture)</h3>
          <div class="videoWrap"><video id="preview" autoplay muted playsinline></video></div>
          <div id="captureStatus" class="status">Initializing camera...</div>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
            <button id="captureRefBtn" disabled>Capture Reference Photo</button>
            <button id="retakeBtn" style="display:none;background:#ef4444">Retake</button>
          </div>
          <div class="muted" style="margin-top:10px">Reference photo is used to detect if the candidate changes during the exam. If the face changes significantly, the exam will be flagged as malpractice.</div>
        </div>

        <!-- Start exam -->
        <div id="step-start" style="display:none">
          <h3 style="margin:12px 0 6px 0">Ready to start</h3>
          <div class="muted">Name: <span id="displayName"></span></div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
            <button id="startBtn" disabled>Start Exam</button>
            <button id="backToCapture" style="background:#ef4444">Back</button>
          </div>
        </div>

        <!-- Exam -->
        <div id="step-exam" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Candidate: <span id="candName"></span></div>
            <div style="text-align:right">
              <div class="timer">Total: <span id="totalTimer">20:00</span></div>
              <div class="muted">Section: <span id="sectionTimer">05:00</span></div>
            </div>
          </div>

          <div class="videoWrap" style="margin-top:12px"><video id="examCam" autoplay muted playsinline></video></div>
          <div id="warn" class="warning"></div>
          <div id="flag" class="flag"></div>

          <div id="qbox" class="qbox">
            <div id="qSubject" style="font-weight:800"></div>
            <div id="qText" style="margin-top:8px;font-weight:700"></div>
            <div id="options" class="opts"></div>
            <div class="controls">
              <button id="nextBtn">Next</button>
              <button id="submitBtn">Submit Exam</button>
            </div>
            <div style="margin-top:8px" class="muted" id="progressText"></div>
          </div>

          <div id="resultPanel" style="display:none">
            <div class="resultBox" id="resultContent"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:12px">
              <button id="retryBtn">Retry</button>
            </div>
          </div>
        </div>

      </div>

      <div class="footer">Â© ATech ICT Solution â€¢ <a class="help" href="https://wa.me/2348145415083" target="_blank" rel="noopener">wa.me/08145415083</a></div>
    </div>
  </div>

<script>
/* Mobile CBT â€” Green theme + lightweight snapshot monitoring
   - capture reference snapshot at start
   - during exam compare new frames to reference (every 3s)
   - if change > threshold => warning; second => flagged out (malpractice)
   - total 20 minutes, 4 sections (5min each), question-by-question
   - MCQ A/B/C, each question 5 marks, total 100
*/

const subjects = [
  { name:'English', questions:[
    {q:'Sentence is a group of ...', opts:['A. World','B. Word','C. Alphabet'], a:1},
    {q:'Choose the antonym of "hot".', opts:['A. Warm','B. Cold','C. Mild'], a:1},
    {q:'Plural of "child" is ...', opts:['A. Childs','B. Childes','C. Children'], a:2},
    {q:'Which is a noun?', opts:['A. Run','B. Apple','C. Quickly'], a:1},
    {q:'Synonym of "happy" is ...', opts:['A. Sad','B. Joyful','C. Angry'], a:1}
  ]},
  { name:'Mathematics', questions:[
    {q:'5 + 5 = ?', opts:['A. 9','B. 10','C. 11'], a:1},
    {q:'12 Ã· 3 = ?', opts:['A. 3','B. 4','C. 5'], a:1},
    {q:'7 Ã— 6 = ?', opts:['A. 42','B. 36','C. 48'], a:0},
    {q:'10 - 4 = ?', opts:['A. 6','B. 5','C. 7'], a:0},
    {q:'3 Ã— 3 = ?', opts:['A. 6','B. 9','C. 8'], a:1}
  ]},
  { name:'Civic Education', questions:[
    {q:'Nigeria gained independence in ...', opts:['A. 1960','B. 1970','C. 1957'], a:0},
    {q:'A democratic responsibility is ...', opts:['A. Voting','B. Looting','C. Forcing'], a:0},
    {q:'Who is head of state in Nigeria?', opts:['A. Governor','B. President','C. Mayor'], a:1},
    {q:'One right of a citizen is ...', opts:['A. Vote','B. Bomb','C. Rob'], a:0},
    {q:'Legislative arm is called ...', opts:['A. Judiciary','B. Executive','C. Legislature'], a:2}
  ]},
  { name:'Nigerian Security', questions:[
    {q:'Which agency handles internal security?', opts:['A. NCDC','B. Army','C. Police'], a:2},
    {q:'Measure to improve security?', opts:['A. Community policing','B. Ignore crime','C. Support criminals'], a:0},
    {q:'What is "integrity"?', opts:['A. Honesty','B. Bribery','C. Secrecy'], a:0},
    {q:'What helps in emergency response?', opts:['A. Good roads','B. Bad governance','C. Noise'], a:0},
    {q:'Who coordinates national security policy?', opts:['A. Local chief','B. President','C. Teacher'], a:1}
  ]}
];

// DOM
const proceedBtn = document.getElementById('proceedBtn');
const preview = document.getElementById('preview');
const captureStatus = document.getElementById('captureStatus');
const captureRefBtn = document.getElementById('captureRefBtn');
const retakeBtn = document.getElementById('retakeBtn');
const stepCapture = document.getElementById('step-capture');
const stepStart = document.getElementById('step-start');
const stepWelcome = document.getElementById('step-welcome');
const stepStartBlock = document.getElementById('step-start');
const displayName = document.getElementById('displayName');
const startBtn = document.getElementById('startBtn');
const backToCapture = document.getElementById('backToCapture');
const stepExam = document.getElementById('step-exam');
const examCam = document.getElementById('examCam');
const qSubject = document.getElementById('qSubject');
const qText = document.getElementById('qText');
const optionsEl = document.getElementById('options');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const progressText = document.getElementById('progressText');
const totalTimerEl = document.getElementById('totalTimer');
const sectionTimerEl = document.getElementById('sectionTimer');
const candName = document.getElementById('candName');
const warnEl = document.getElementById('warn');
const flagEl = document.getElementById('flag');
const resultPanel = document.getElementById('resultPanel');
const resultContent = document.getElementById('resultContent');
const retryBtn = document.getElementById('retryBtn');

let previewStream = null, examStream = null;
let refImageData = null; // reference snapshot
let refHash = null;
let warningGiven = false, flagged = false, warnCount = 0, flagCount = 0;

let totalSeconds = 20 * 60;
let sectionSeconds = 5 * 60;
let totalTimerInterval = null, sectionTimerInterval = null, monitorInterval = null;

let currentSubject = 0, currentQ = 0;
let answers = new Array(20).fill(null);

// small helpers: canvas for capture & compare
const canvas = document.createElement('canvas');
canvas.width = 320; canvas.height = 240;
const ctx = canvas.getContext('2d');

function takeSnapshot(videoEl){
  try{
    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
    return ctx.getImageData(0,0,canvas.width,canvas.height);
  }catch(e){
    return null;
  }
}

// compute simple normalized diff between two ImageData
function imageDiffRatio(a,b){
  if(!a||!b) return 1;
  const len = a.data.length;
  let diff = 0;
  // sample pixels to reduce CPU
  const step = 8; // sample every 8th channel (~every 2 pixels)
  for(let i=0;i<len;i+=4*step){
    const r1=a.data[i], g1=a.data[i+1], b1=a.data[i+2];
    const r2=b.data[i], g2=b.data[i+1], b2=b.data[i+2];
    diff += Math.abs(r1-r2) + Math.abs(g1-g2) + Math.abs(b1-b2);
  }
  const max = (len/(4*step)) * 3 * 255;
  return diff / max; // 0..1
}

// tiny hash for quick compare (not secure, just quick)
function quickHash(img){
  if(!img) return '';
  let s = 0;
  for(let i=0;i<img.data.length;i+=4*64) s = (s + img.data[i] + img.data[i+1] + img.data[i+2]) % 100000;
  return String(s);
}

// beep
function beep(ms=220,f=700){ try{ const C=new (window.AudioContext||window.webkitAudioContext)(); const o=C.createOscillator(); const g=C.createGain(); o.connect(g); g.connect(C.destination); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0.16,C.currentTime); o.start(); o.stop(C.currentTime+ms/1000);}catch(e){} }

// UI flow: Proceed -> open camera preview
proceedBtn.addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  if(!name) return alert('Please enter your name');
  stepWelcome.style.display = 'none';
  stepCapture.style.display = 'block';
  displayName.textContent = name;
  document.getElementById('displayName').textContent = name;
  try{
    previewStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    preview.srcObject = previewStream;
    captureStatus.textContent = 'Camera started. Align your face and tap "Capture Reference Photo".';
    captureRefBtn.disabled = false;
  }catch(e){
    alert('Camera permission required. Allow and reload.');
    location.reload();
  }
});

// capture reference
captureRefBtn.addEventListener('click', ()=>{
  const img = takeSnapshot(preview);
  if(!img) return alert('Failed to capture. Try again.');
  refImageData = img;
  refHash = quickHash(img);
  captureStatus.textContent = 'Reference photo captured. You may retake if not clear.';
  retakeBtn.style.display = 'inline-block';
  startBtn.disabled = false;
  // show preview thumbnail briefly
  beep(200,900);
});

// retake
retakeBtn.addEventListener('click', ()=>{
  refImageData = null; refHash = null;
  captureStatus.textContent = 'Reference cleared. Align face and capture again.';
  retakeBtn.style.display = 'none';
  startBtn.disabled = true;
});

// show start block
captureRefBtn.addEventListener('click', ()=>{
  if(refImageData) {
    stepStart.style.display = 'block';
    document.getElementById('displayName').textContent = document.getElementById('name').value.trim();
  }
});

// back to capture
backToCapture.addEventListener('click', ()=>{
  stepStart.style.display = 'none';
  stepCapture.style.display = 'block';
});

// start exam: open exam camera, start timers & monitoring
startBtn.addEventListener('click', async ()=>{
  if(!refImageData) return alert('Please capture reference photo first.');
  stepCapture.style.display = 'none';
  stepStart.style.display = 'none';
  stepExam.style.display = 'block';
  candName.textContent = document.getElementById('name').value.trim();
  // start exam camera
  try{
    examStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    examCam.srcObject = examStream;
  }catch(e){
    alert('Exam camera failed. Allow camera and retry.');
    location.reload();
  }
  // init state
  totalSeconds = 20*60; sectionSeconds = 5*60;
  currentSubject = 0; currentQ = 0;
  answers = new Array(20).fill(null);
  warningGiven = false; flagged = false; warnCount = 0; flagCount = 0;
  updateTimersUI(); showCurrentQuestion();
  startTotalTimer(); startSectionTimer();
  startMonitoringLoop();
});

// render question
function showCurrentQuestion(){
  const subj = subjects[currentSubject];
  const qObj = subj.questions[currentQ];
  qSubject.textContent = subj.name;
  qText.textContent = qObj.q;
  optionsEl.innerHTML = '';
  qObj.opts.forEach((opt, idx)=>{
    const id = `opt_${currentSubject}_${currentQ}_${idx}`;
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="opt" id="${id}" value="${idx}"> ${opt}`;
    optionsEl.appendChild(label);
  });
  progressText.textContent = `Subject ${currentSubject+1}/${subjects.length} â€¢ Q ${currentQ+1}/5`;
}

// next button
nextBtn.addEventListener('click', ()=>{
  if(flagged) return alert('Exam flagged out â€” cannot continue');
  const sel = document.querySelector('input[name="opt"]:checked');
  const overall = currentSubject*5 + currentQ;
  if(sel) answers[overall] = Number(sel.value);
  // move to next
  if(currentQ < 4){
    currentQ++; showCurrentQuestion();
  } else {
    // finished subject
    if(currentSubject < subjects.length -1){
      currentSubject++; currentQ = 0; sectionSeconds = 5*60; showCurrentQuestion();
    } else {
      computeAndShowResults();
    }
  }
});

// submit manual
submitBtn.addEventListener('click', ()=>{
  if(confirm('Submit exam now?')) computeAndShowResults();
});

// timers
function updateTimersUI(){
  const tm = Math.floor(totalSeconds/60), ts = totalSeconds%60;
  totalTimerEl.textContent = `${String(tm).padStart(2,'0')}:${String(ts).padStart(2,'0')}`;
  const sm = Math.floor(sectionSeconds/60), ss = sectionSeconds%60;
  sectionTimerEl.textContent = `${String(sm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function startTotalTimer(){
  updateTimersUI();
  totalTimerInterval = setInterval(()=>{
    totalSeconds--; updateTimersUI();
    if(totalSeconds <= 0){ clearInterval(totalTimerInterval); clearInterval(sectionTimerInterval); computeAndShowResults(); }
  },1000);
}
function startSectionTimer(){
  updateTimersUI();
  sectionTimerInterval = setInterval(()=>{
    sectionSeconds--; updateTimersUI();
    if(sectionSeconds <= 0){
      if(currentSubject < subjects.length -1){
        currentSubject++; currentQ = 0; sectionSeconds = 5*60; showCurrentQuestion();
      } else {
        computeAndShowResults();
      }
    }
  },1000);
}

// monitoring: compare snapshots every 3s
function startMonitoringLoop(){
  monitorInterval = setInterval(()=>{
    if(flagged) return;
    const cur = takeSnapshot(examCam);
    if(!cur){ console.warn('frame capture failed'); return; }
    const ratio = imageDiffRatio(refImageData, cur); // 0..1
    // small tolerance because lighting + head movement expected
    // If ratio > 0.18 => significant change (possible different person / different face)
    // If ratio > 0.12 => suspicious (warning)
    // tune thresholds if needed for your devices
    log(`monitor ratio:${ratio.toFixed(3)}`);
    if(ratio > 0.18){
      // immediate malpractice -> flagged out
      handleFlag('Significant face change detected (possible different person / major change).');
    } else if(ratio > 0.12){
      // suspicious -> warning or second -> flagged
      if(!warningGiven){
        warningGiven = true; warnCount++; warnEl.textContent = 'âš ï¸ Warning: Face differs from reference â€” please return to camera';
        beep(300,900);
      } else {
        handleFlag('Repeated suspicious behavior detected (face changed).');
      }
    } else {
      // okay -> clear warning message
      warnEl.textContent = '';
    }
  }, 3000);
}

function handleFlag(reason){
  if(flagged) return;
  flagged = true; flagCount++; flagEl.textContent = 'ðŸš« Malpractice detected: Exam stopped';
  beep(1000,300);
  log('Flagged: ' + reason);
  // stop cameras and timers
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
  clearInterval(monitorInterval); clearInterval(totalTimerInterval); clearInterval(sectionTimerInterval);
  // disable inputs
  Array.from(document.querySelectorAll('input[type=radio]')).forEach(i=>i.disabled = true);
  nextBtn.disabled = true; submitBtn.disabled = true;
  // show malpractice result
  resultPanel.style.display = 'block';
  resultContent.innerHTML = `<div style="font-weight:800;color:#a02121">MALPRACTICE DETECTED</div>
    <div style="margin-top:8px">Your session was flagged for suspicious face change or absence. Exam stopped.</div>`;
  document.getElementById('qbox').style.display = 'none';
}

// compute result
function computeAndShowResults(){
  clearInterval(monitorInterval); clearInterval(totalTimerInterval); clearInterval(sectionTimerInterval);
  // save current selection
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) answers[currentSubject*5 + currentQ] = Number(sel.value);
  // compute
  let perSub = [], totalCorrect = 0;
  for(let s=0;s<subjects.length;s++){
    let correct = 0;
    for(let q=0;q<5;q++){
      const idx = s*5 + q;
      if(typeof answers[idx] === 'number' && answers[idx] === subjects[s].questions[q].a) correct++;
    }
    perSub.push(correct);
    totalCorrect += correct;
  }
  const totalMarks = totalCorrect * 5; // 0..100
  // grade
  let grade = '';
  if(totalMarks >= 80) grade = 'Distinction';
  else if(totalMarks >= 65) grade = 'Upper Class';
  else if(totalMarks >= 50) grade = 'Lower Class';
  else if(totalMarks >= 40) grade = 'Pass';
  else if(totalMarks >= 30) grade = 'Play Class';
  else grade = 'Failed â€” Retry';
  // show
  let html = `<div style="font-weight:800">Result for ${document.getElementById('name').value}</div>`;
  html += `<div style="margin-top:8px">Per-subject:</div><ul>`;
  for(let s=0;s<subjects.length;s++){
    html += `<li>${subjects[s].name}: ${perSub[s]} / 5 (${perSub[s]*5} marks)</li>`;
  }
  html += `</ul><div style="margin-top:8px"><strong>Total: ${totalMarks} / 100</strong></div>`;
  html += `<div style="margin-top:8px"><strong>Grade: ${grade}</strong></div>`;
  resultContent.innerHTML = html;
  resultPanel.style.display = 'block';
  document.getElementById('qbox').style.display = 'none';
  // stop camera
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
}

// util: log to right panel
function log(msg){ const e = document.getElementById('log'); e.textContent = msg + '\n' + e.textContent; }

// retry
retryBtn.addEventListener('click', ()=> location.reload());

// quick init: nothing to do until user proceeds
log('Ready â€” mobile CBT (green).');

</script>
</body>
</html>
