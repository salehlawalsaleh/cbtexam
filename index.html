<!doctype html>
<html lang="ha">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>CBT Exam â€” ATech ICT Solution</title>
<meta name="theme-color" content="#16A34A" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{
    --bg:#f0fff4; --card:#ffffff; --accent:#16A34A; --accent-700:#127338;
    --muted:#4b5563; --soft:#ecfef3; --warn:#f59e0b; --danger:#dc2626;
    --glass: rgba(255,255,255,0.75);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,-apple-system,"Segoe UI",Arial;background:linear-gradient(180deg,#f8fff9 0%, #eefef0 100%);color:#052e14;-webkit-font-smoothing:antialiased;min-height:100vh;display:flex;align-items:stretch;justify-content:center;padding:14px;}
  .app{width:100%;max-width:980px;display:flex;flex-direction:column;gap:12px}
  /* NAV */
  .nav{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--glass),#f6fff6);padding:12px 16px;border-radius:12px;box-shadow:0 6px 18px rgba(6,95,70,0.07);border:1px solid rgba(6,95,70,0.05)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-700));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
  .brand .text{font-weight:700;font-size:16px;color:var(--accent-700)}
  .nav .sub{font-size:13px;color:var(--muted)}
  .helpLink{background:#25D366;color:white;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700;display:inline-flex;gap:8px;align-items:center}
  /* main */
  .main{display:grid;grid-template-columns:1fr 320px;gap:14px;align-items:start}
  @media(max-width:900px){ .main{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 12px 30px rgba(6,95,70,0.05);border:1px solid rgba(6,95,70,0.04)}
  .title{font-weight:800;color:var(--accent-700);font-size:18px;margin-bottom:6px}
  .muted{color:var(--muted);font-size:13px}
  .progressWrap{display:flex;align-items:center;gap:12px;padding:12px 0}
  .stepText{font-weight:700;color:var(--accent-700);font-size:14px}
  .progressBar{flex:1;height:8px;background:#e9f6ef;border-radius:999px;overflow:hidden}
  .progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-700));border-radius:999px;transition:width .35s ease}
  /* inputs (ENHANCED pill) */
  .inputWrap{display:flex;align-items:center;gap:10px;background:#fbfff9;border-radius:30px;padding:8px;border:1px solid rgba(6,95,70,0.04);box-shadow:0 8px 28px rgba(6,95,70,0.04)}
  .inputIcon{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-700));display:flex;align-items:center;justify-content:center;color:white;font-size:18px}
  input[type="text"]{flex:1;padding:14px;border-radius:20px;border:0;background:transparent;font-size:17px;outline:none;box-shadow:none}
  input[type="text"]:focus{box-shadow:0 10px 30px rgba(6,95,70,0.06); outline:none}
  .btn{background:var(--accent);color:white;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn.secondary{background:transparent;border:1px solid rgba(6,95,70,0.08);color:var(--accent-700);padding:10px 12px;border-radius:10px}
  .btn.print{background:linear-gradient(90deg,#06b6d4,#0891b2);border-radius:10px;padding:10px 12px}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .videoWrap{display:flex;justify-content:center;margin:12px 0}
  video{width:300px;height:220px;border-radius:12px;border:4px solid rgba(22,163,74,0.06);background:#000;object-fit:cover;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  .qbox{margin-top:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#f9fff5);border:1px solid rgba(6,95,70,0.03)}
  .opts{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .optCard{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;border:1px solid #eef9ef;background:white;cursor:pointer;transition:transform .08s ease,box-shadow .08s ease}
  .optCard input{display:none}
  .optCard .labelText{font-weight:700}
  .optCard.selected{background:linear-gradient(90deg,#ecfdf5,#f0fff9);border-color:var(--accent-700);box-shadow:0 12px 30px rgba(6,95,70,0.06);transform:translateY(-3px)}
  .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .aside .rules li{margin:8px 0;font-size:14px}
  .resultBox{padding:12px;background:#ecfff5;border-radius:10px;margin-top:12px}
  .footer{padding:10px;text-align:center;font-size:13px;color:var(--muted);border-top:1px solid rgba(6,95,70,0.03);background:transparent}
  .hidden{display:none !important}
  /* red instruction box */
  .redBox{margin-top:12px;padding:12px;border-radius:10px;background:#fff5f5;border-left:4px solid rgba(220,38,38,0.9);color:#7a271f}
  /* toasts */
  .toasts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{min-width:220px;padding:12px 14px;border-radius:10px;color:white;box-shadow:0 10px 30px rgba(2,6,23,0.18);display:flex;gap:10px;align-items:center;font-weight:700}
  .toast.success{background:linear-gradient(90deg,#10b981,#059669)}
  .toast.info{background:linear-gradient(90deg,#06b6d4,#0891b2)}
  .toast.warn{background:linear-gradient(90deg,#f59e0b,#d97706)}
  .toast.error{background:linear-gradient(90deg,#ef4444,#dc2626)}
  /* loader (step 4) */
  .loaderWrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:20px}
  .spinner{width:72px;height:72px;border-radius:999px;border:6px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .percent{font-weight:800;color:var(--accent-700);font-size:18px}
  /* profile pill for displayName in step 2 */
  .profilePill{display:inline-flex;gap:10px;align-items:center;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fbfff9,#f6fff6);border:1px solid rgba(6,95,70,0.04)}
  .profileAvatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-700));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  @media(max-width:420px){ video{width:240px;height:180px} .btn{padding:10px 12px} .optCard{padding:10px} }

  /* small modern congratulations card (only used inside results) */
  .congratsCard{
    display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;
    background:linear-gradient(90deg,#ecfeff,#f0fff9);border:1px solid rgba(6,95,70,0.06);
    box-shadow:0 12px 30px rgba(6,95,70,0.04);
  }
  .congratsIcon{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#0891b2);display:flex;align-items:center;justify-content:center;color:white;font-size:22px;font-weight:800}

  /* --- confirm overlay/modal (centered) --- */
  #confirmOverlay.hidden { display: none; }
  #confirmOverlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(2,6,23,0.35);
    z-index: 22000;
    padding: 18px;
  }
  #confirmOverlay .confirmBox {
    width: 100%;
    max-width: 420px;
    background: var(--card);
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 18px 50px rgba(2,6,23,0.2);
    border: 1px solid rgba(6,95,70,0.04);
    text-align: center;
  }
  #confirmOverlay .confirmBox .btn { min-width: 96px; }
</style>
</head>
<body>
  <div class="app">
    <div class="nav">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-shield-halved"></i></div>
        <div>
          <div class="text">ATech ICT</div>
          <div class="sub" id="navSub">Mobile-first â€¢ Strict monitoring</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="helpLink" href="https://wa.me/2348145415083" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Help</a>
      </div>
    </div>

    <div class="main">
      <div class="card left">
        <!-- pageTitle/subtitle will be hidden automatically when user advances -->
        <div class="title" id="pageTitle">Online CBT â€” ATech ICT Solution</div>
        <div class="muted" id="pageSubtitle" style="margin-bottom:8px">Multi-step exam training â€” camera monitoring enabled</div>

        <div class="progressWrap">
          <div class="stepText" id="stepText">Step 1 â€” Enter name</div>
          <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
        </div>

        <!-- STEP 1 -->
        <div id="step1">
          <div style="margin:10px 0">
            <label class="muted">Enter your full name</label>
            <div class="inputWrap" style="margin-top:8px">
              <div class="inputIcon"><i class="fa-solid fa-user"></i></div>
              <!-- maxlength 15 added below -->
              <input id="nameInput" placeholder="Musa Ahmed" autocomplete="name" maxlength="15" />
            </div>
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end">
            <button id="proceedBtn" class="btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
          </div>
        </div>

        <!-- STEP 2 (capture ref) -->
        <div id="step2" class="hidden" aria-hidden="true">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;flex-direction:column;gap:6px">
              <!-- profile pill -->
              <div class="profilePill" id="profilePill">
                <div class="profileAvatar" id="profileAvatar"><i class="fa-solid fa-user"></i></div>
                <div style="font-weight:800" id="displayName">â€”</div>
              </div>
              <div class="muted" style="font-size:13px">Welcome â€” capture your reference</div>
            </div>
            <div class="muted">Reference photo used for monitoring</div>
          </div>

          <!-- red instruction box -->
          <div class="redBox" id="redInstr">
            INSTRUCTIONS: Ensure your face is centered, well-lit and not wearing shades. Reference will be used for continuous monitoring.
          </div>

          <div class="videoWrap"><video id="preview" autoplay muted playsinline></video></div>
          <div id="captureStatus" class="status muted">Waiting for camera...</div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="backToStep1" class="btn secondary"><i class="fa-solid fa-arrow-left"></i> Back</button>
            <button id="captureBtn" class="btn secondary" disabled><i class="fa-solid fa-camera"></i> Capture</button>
            <button id="startBtn" class="btn" disabled><i class="fa-solid fa-play"></i> Start Exam</button>
          </div>
        </div>

        <!-- STEP 3: Exam (no rules shown here) -->
        <div id="step3" class="hidden" aria-hidden="true">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Candidate: <span id="candName"></span></div>
            <div style="text-align:right">
              <div class="timer">Total: <span id="totalTimer">10:00</span></div>
              <div class="muted">Section: <span id="sectionTimer">02:30</span></div>
            </div>
          </div>

          <div class="videoWrap" style="margin-top:12px"><video id="examCam" autoplay muted playsinline></video></div>
          <div id="warnMsg" class="warning" role="alert"></div>
          <div id="flagMsg" class="flag" role="alert"></div>

          <div id="qbox" class="qbox">
            <div id="qSubject" style="font-weight:800"></div>
            <div id="qText" style="margin-top:8px;font-weight:700"></div>
            <div id="options" class="opts" role="group" aria-label="Question options"></div>

            <div class="controls">
              <button id="prevBtn" class="btn secondary"><i class="fa-solid fa-chevron-left"></i> Previous</button>
              <button id="nextBtn" class="btn"><i class="fa-solid fa-chevron-right"></i> Next</button>
              <button id="submitBtn" class="btn"><i class="fa-solid fa-paper-plane"></i> Submit</button>
            </div>
            <div style="margin-top:8px" class="muted" id="progressText"></div>
          </div>
        </div>

        <!-- STEP 4: Results (loader -> then results) -->
        <div id="step4" class="hidden" aria-hidden="true">
          <h3 style="margin:0 0 8px 0">Results</h3>

          <!-- loading container -->
          <div id="resultsLoader" class="loaderWrap hidden" aria-hidden="true">
            <div class="spinner" aria-hidden="true"></div>
            <div class="muted">We are calculating your results â€” please wait</div>
            <div class="percent" id="percentText">0%</div>
          </div>

          <div id="resultContent" class="resultBox hidden" aria-hidden="true"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted">Thank you for taking the exam</div>
            <a class="helpLink" href="https://wa.me/2348145415083" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Contact</a>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px">
            <button id="retryBtn" class="btn secondary">Retry</button>
          </div>
        </div>

      </div>

      <aside id="rulesAside" class="card aside">
        <div class="title" style="font-size:16px">Exam Rules</div>
        <div class="muted" style="margin-top:8px">
          <ul class="rules">
            <li>48 questions â€” 12 per subject (English â†’ Math â†’ Civic â†’ Nigerian Security)</li>
            <li>Each subject = 2.5 minutes (auto-advance)</li>
            <li>Total = 10 minutes (auto submit)</li>
            <li>Marks per question = 100 / 48 (total = 100)</li>
            <li><strong>Strict:</strong> 1st violation = warning; if not corrected within 5s â†’ flagged out.</li>
          </ul>
        </div>
        <div style="margin-top:12px">
          <div class="muted">Contact</div>
          <div style="margin-top:8px"><a class="helpLink" href="https://wa.me/2348145415083" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> wa.me/08145415083</a></div>
        </div>
      </aside>
    </div>

    <div class="footer">Â© ATech ICT Solution</div>
  </div>

  <!-- toasts container -->
  <div class="toasts" id="toasts"></div>

  <!-- confirm overlay (centered modal) -->
  <div id="confirmOverlay" class="hidden"></div>

<script>
/* Same behaviour as before with two changes requested:
   1) name input now has maxlength=15 (enforced in HTML) and extra check before proceed
   2) QR generation switched to api.qrserver.com (more reliable for varied payloads)
*/

// question sets (same as last)
// ... (omitted in this small comment block - full data follows)
const subjects = [
  { name:'English', questions:[
    {q:'Sentence is a group of ...', opts:['World','Word','Alphabet'], a:1},
    {q:'Antonym of "hot" is ...', opts:['Warm','Cold','Mild'], a:1},
    {q:'Plural of "child"?', opts:['Childs','Childes','Children'], a:2},
    {q:'Which is a noun?', opts:['Run','Apple','Quickly'], a:1},
    {q:'Synonym of "happy"?', opts:['Sad','Joyful','Angry'], a:1},
    {q:'Choose correct article: ___ apple', opts:['A','An','The'], a:1},
    {q:'Which is a verb?', opts:['Jump','Blue','Tall'], a:0},
    {q:'Opposite of "early"?', opts:['Late','Soon','Before'], a:0},
    {q:'Plural of "mouse"?', opts:['Mouses','Mice','Mouse'], a:1},
    {q:'What is an adjective?', opts:['Describes noun','Action word','Name'], a:0},
    {q:'Choose correct preposition: She is ___ the room', opts:['in','on','at'], a:0},
    {q:'Which is past tense of "go"?', opts:['goed','went','gone'], a:1}
  ]},
  { name:'Mathematics', questions:[
    {q:'5 + 5 = ?', opts:['9','10','11'], a:1},
    {q:'12 Ã· 3 = ?', opts:['3','4','5'], a:1},
    {q:'7 Ã— 6 = ?', opts:['42','36','48'], a:0},
    {q:'10 - 4 = ?', opts:['6','5','7'], a:0},
    {q:'3 Ã— 3 = ?', opts:['6','9','8'], a:1},
    {q:'Square root of 81?', opts:['9','8','7'], a:0},
    {q:'2^3 = ?', opts:['6','8','9'], a:1},
    {q:'Which is even?', opts:['11','14','13'], a:1},
    {q:'Decimal of 1/2?', opts:['0.5','0.2','2'], a:0},
    {q:'Perimeter of square side 4?', opts:['12','16','8'], a:1},
    {q:'What is 15% of 200?', opts:['20','30','40'], a:1},
    {q:'LCM of 4 and 6?', opts:['12','24','6'], a:0}
  ]},
  { name:'Civic Education', questions:[
    {q:'Nigeria gained independence in ...', opts:['1960','1970','1957'], a:0},
    {q:'A democratic responsibility is ...', opts:['Voting','Looting','Forcing'], a:0},
    {q:'Who is head of state?', opts:['Governor','President','Mayor'], a:1},
    {q:'One right of a citizen is ...', opts:['Vote','Bomb','Rob'], a:0},
    {q:'Legislative arm is ...', opts:['Judiciary','Executive','Legislature'], a:2},
    {q:'What is a constitution?', opts:['Law document','Food','City'], a:0},
    {q:'Local government head is called?', opts:['Chairman','President','Judge'], a:0},
    {q:'A civic duty includes ...', opts:['Paying taxes','Stealing','Vandalism'], a:0},
    {q:'Role of judiciary?', opts:['Interpret laws','Make laws','Execute laws'], a:0},
    {q:'Democracy means ...', opts:['Rule by people','Rule by one','No rules'], a:0},
    {q:'A fundamental duty is ...', opts:['Obeying law','Breaking law','Corruption'], a:0},
    {q:'Who makes laws at national level?', opts:['Assembly','Court','Police'], a:0}
  ]},
  { name:'Nigerian Security', questions:[
    {q:'Which agency handles internal security?', opts:['NCDC','Army','Police'], a:2},
    {q:'Measure to improve security?', opts:['Community policing','Ignore crime','Support criminals'], a:0},
    {q:'What is "integrity"?', opts:['Honesty','Bribery','Secrecy'], a:0},
    {q:'What helps emergency response?', opts:['Good roads','Bad governance','Noise'], a:0},
    {q:'Who coordinates national security policy?', opts:['Local chief','President','Teacher'], a:1},
    {q:'What is a security check?', opts:['Screening','Singing','Eating'], a:0},
    {q:'Which helps reduce crime?', opts:['Education','Corruption','Silence'], a:0},
    {q:'Role of police?', opts:['Maintain law & order','Promote crime','Tax people'], a:0},
    {q:'Emergency number in Nigeria?', opts:['911','112','199'], a:1},
    {q:'What is cyber security?', opts:['Protecting online systems','Cooking','Farming'], a:0},
    {q:'What prevents fraud online?', opts:['Strong passwords','Sharing PIN','Weak codes'], a:0},
    {q:'Which agency tackles health emergencies?', opts:['NCDC','Army','Police'], a:0}
  ]}
];

const QUESTIONS_PER_SUBJECT = 12, SUBJECT_COUNT = subjects.length, TOTAL_QUESTIONS = SUBJECT_COUNT * QUESTIONS_PER_SUBJECT;
const MARK_PER_Q = 100 / TOTAL_QUESTIONS;

// UI helpers
const toastsEl = document.getElementById('toasts');
function showToast(msg, type='info', ms=3200){
  const t = document.createElement('div');
  t.className = 'toast ' + (type||'info');
  t.innerHTML = `<i class="fa-solid fa-bell"></i><div style="flex:1">${msg}</div>`;
  toastsEl.appendChild(t);
  setTimeout(()=> t.style.opacity = '0.98', 10);
  setTimeout(()=> { t.style.transition='opacity .25s ease, transform .25s ease'; t.style.opacity='0'; t.style.transform='translateY(8px)'; setTimeout(()=> t.remove(), 300); }, ms);
}
function showConfirm(message){
  return new Promise(resolve=>{
    const overlay = document.getElementById('confirmOverlay');
    overlay.innerHTML = `
      <div class="confirmBox">
        <div style="font-weight:800">${message}</div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
          <button id="confNo" class="btn secondary">No</button>
          <button id="confYes" class="btn">Yes</button>
        </div>
      </div>`;
    overlay.classList.remove('hidden');
    const yes = document.getElementById('confYes'), no = document.getElementById('confNo');
    yes.onclick = ()=> { overlay.classList.add('hidden'); overlay.innerHTML=''; resolve(true); };
    no.onclick = ()=> { overlay.classList.add('hidden'); overlay.innerHTML=''; resolve(false); };
  });
}

// audio/vibrate warning
let audioCtx = null;
function playWarningBeef(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(120, t);
    g.gain.setValueAtTime(0.001, t);
    g.gain.linearRampToValueAtTime(0.12, t+0.02);
    g.gain.linearRampToValueAtTime(0.0, t+0.55);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+0.55);
    const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
    o2.type = 'sine'; o2.frequency.setValueAtTime(220, t);
    g2.gain.setValueAtTime(0.0, t); g2.gain.linearRampToValueAtTime(0.06, t+0.02); g2.gain.linearRampToValueAtTime(0.0, t+0.55);
    o2.connect(g2); g2.connect(audioCtx.destination); o2.start(); o2.stop(t+0.55);
  }catch(e){ console.warn('Audio ctx not available', e); }
}
function vibratePattern(){ try{ if(navigator.vibrate) navigator.vibrate([180,80,160]); }catch(e){} }
function warnFeedback(){ vibratePattern(); playWarningBeef(); }

// snapshot helpers
const canvas = document.createElement('canvas'); canvas.width=320; canvas.height=240;
const ctx = canvas.getContext('2d');
function takeSnapshot(videoEl){ try{ ctx.drawImage(videoEl,0,0,canvas.width,canvas.height); return ctx.getImageData(0,0,canvas.width,canvas.height); }catch(e){ return null; } }
function avgLuminance(img){ if(!img) return 0; let sum=0,cnt=0; for(let i=0;i<img.data.length;i+=4*30){ const r=img.data[i], g=img.data[i+1], b=img.data[i+2]; sum += 0.299*r + 0.587*g + 0.114*b; cnt++; } return Math.round(sum/cnt || 0); }
function imageDiffRatio(a,b){ if(!a||!b) return 1; let diff=0; const step=12; for(let i=0;i<a.data.length;i+=4*step){ diff += Math.abs(a.data[i]-b.data[i]) + Math.abs(a.data[i+1]-b.data[i+1]) + Math.abs(a.data[i+2]-b.data[i+2]); } const max = (a.data.length/(4*step)) * 3 * 255; return diff / max; }

// state & refs
let previewStream=null, examStream=null, refImage=null;
let refDataUrl = null;
let totalSeconds=10*60, sectionSeconds=Math.floor((10*60)/4), totalTimerInterval=null, sectionTimerInterval=null;
let monitorInterval=null, graceTimer=null;
let currentSubject=0, currentQ=0;
let answers = new Array(TOTAL_QUESTIONS).fill(null);
let warned=false, flagged=false;
let userQuestionPool = [];

const stepText = document.getElementById('stepText'), progressFill = document.getElementById('progressFill');
const step1El = document.getElementById('step1'), step2El = document.getElementById('step2'), step3El = document.getElementById('step3'), step4El = document.getElementById('step4');
const proceedBtn = document.getElementById('proceedBtn'), nameInput = document.getElementById('nameInput'), displayName = document.getElementById('displayName');
const previewVideo = document.getElementById('preview'), captureBtn = document.getElementById('captureBtn'), startBtn = document.getElementById('startBtn'), backToStep1 = document.getElementById('backToStep1');
const candNameEl = document.getElementById('candName'), examCam = document.getElementById('examCam');
const qSubjectEl = document.getElementById('qSubject'), qTextEl = document.getElementById('qText'), optionsEl = document.getElementById('options');
const prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn'), submitBtn = document.getElementById('submitBtn');
const progressText = document.getElementById('progressText'), totalTimerEl = document.getElementById('totalTimer'), sectionTimerEl = document.getElementById('sectionTimer');
const warnEl = document.getElementById('warnMsg'), flagEl = document.getElementById('flagMsg'), resultContent = document.getElementById('resultContent');
const retryBtn = document.getElementById('retryBtn');
const pageTitle = document.getElementById('pageTitle'), pageSubtitle = document.getElementById('pageSubtitle'), navSub = document.getElementById('navSub');
const rulesAside = document.getElementById('rulesAside');
const profileAvatar = document.getElementById('profileAvatar');
const resultsLoader = document.getElementById('resultsLoader'), percentText = document.getElementById('percentText');

// helpers
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function prepareUserQuestions(){ userQuestionPool = subjects.map(s => shuffleArray(s.questions.map(q => ({...q}))) ); showToast('Questions randomized for this session', 'info', 1400); }

// setStep
function setStep(n){
  step1El.classList.add('hidden'); step2El.classList.add('hidden'); step3El.classList.add('hidden'); step4El.classList.add('hidden');
  if(n===1) step1El.classList.remove('hidden');
  if(n===2) step2El.classList.remove('hidden');
  if(n===3) step3El.classList.remove('hidden');
  if(n===4) step4El.classList.remove('hidden');
  const titles = ['Enter name','Reference picture','Exam in progress','Results'];
  stepText.textContent = `Step ${n} â€” ${titles[n-1]}`;
  progressFill.style.width = `${((n-1)/3)*100}%`;

  if(n >= 2){
    if(pageTitle) pageTitle.style.display='none';
    if(pageSubtitle) pageSubtitle.style.display='none';
    if(navSub) navSub.style.display='none';
    if(rulesAside) rulesAside.style.display='none';
  } else {
    if(pageTitle) pageTitle.style.display='block';
    if(pageSubtitle) pageSubtitle.style.display='block';
    if(navSub) navSub.style.display='block';
    if(rulesAside) rulesAside.style.display='block';
  }
}
setStep(1);

// Proceed (Step1 -> Step2) with maxlength check
proceedBtn.addEventListener('click', async ()=>{
  let name = nameInput.value.trim();
  if(!name){ showToast('Please enter your name', 'warn'); return; }
  if(name.length > 15){
    showToast('Name cannot exceed 15 characters', 'warn');
    // truncate safely
    name = name.slice(0,15);
    nameInput.value = name;
  }
  displayName.textContent = name;
  // initials limited properly
  profileAvatar.innerHTML = name.split(' ').map(n=>n[0]||'').slice(0,2).join('').toUpperCase();
  prepareUserQuestions();
  setStep(2);
  try{
    previewStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    previewVideo.srcObject = previewStream;
    captureBtn.disabled = false;
    showToast('Camera ready â€” capture reference', 'success', 1600);
    previewStream.getVideoTracks()[0].onended = ()=> { showToast('Preview camera ended', 'error', 3000); };
  }catch(e){
    showToast('Camera permission required', 'error', 3200);
    setStep(1);
  }
});

// back
backToStep1.addEventListener('click', ()=>{
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  setStep(1);
});

// capture reference
captureBtn.addEventListener('click', ()=>{
  const img = takeSnapshot(previewVideo);
  if(!img){ showToast('Capture failed â€” try again', 'error'); return; }
  const lum = avgLuminance(img);
  if(lum < 25){ showToast('Too dark â€” increase lighting and retake', 'warn'); return; }
  refImage = img;
  try{
    ctx.drawImage(previewVideo,0,0,canvas.width,canvas.height);
    refDataUrl = canvas.toDataURL('image/png');
  }catch(e){ refDataUrl = null; }
  showToast('Reference photo captured', 'success', 1400);
  startBtn.disabled = false;
});

// start exam
startBtn.addEventListener('click', async ()=>{
  if(!refImage){ showToast('Please capture reference first', 'warn'); return; }
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  setStep(3);
  candNameEl.textContent = nameInput.value.trim().slice(0,15);
  try{
    examStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    examCam.srcObject = examStream;
    examStream.getVideoTracks()[0].onended = ()=> handleStreamEnded('Exam camera stopped');
  }catch(e){
    showToast('Exam camera failed â€” allow camera', 'error', 3500);
    location.reload();
    return;
  }
  totalSeconds = 10*60;
  sectionSeconds = Math.floor((10*60)/SUBJECT_COUNT);
  currentSubject=0; currentQ=0;
  answers = new Array(TOTAL_QUESTIONS).fill(null); warned=false; flagged=false;
  updateTimersUI(); renderQuestion(); startTotalTimer(); startSectionTimer(); startMonitoring();
  showToast('Exam started â€” monitoring active', 'info', 1400);
});

// render question
function renderQuestion(){
  const subjPool = userQuestionPool[currentSubject];
  const qObj = subjPool[currentQ];
  qSubjectEl.textContent = subjects[currentSubject].name + ` (Q ${currentQ+1}/${QUESTIONS_PER_SUBJECT})`;
  qTextEl.textContent = qObj.q;
  optionsEl.innerHTML = '';
  qObj.opts.forEach((opt, idx)=>{
    const overall = currentSubject*QUESTIONS_PER_SUBJECT + currentQ;
    const id = `opt_${currentSubject}_${currentQ}_${idx}`;
    const wrapper = document.createElement('div');
    wrapper.className = 'optCard';
    wrapper.innerHTML = `<input type="radio" name="opt" id="${id}" value="${idx}" aria-label="${opt}"><div class="labelText">${opt}</div>`;
    wrapper.addEventListener('click', ()=>{
      Array.from(optionsEl.querySelectorAll('.optCard')).forEach(c => c.classList.remove('selected'));
      wrapper.classList.add('selected');
      const input = wrapper.querySelector('input[type="radio"]');
      input.checked = true;
      answers[overall] = Number(input.value);
    });
    optionsEl.appendChild(wrapper);
  });
  progressText.textContent = `Subject ${currentSubject+1}/${SUBJECT_COUNT} â€¢ Q ${(currentQ+1) + currentSubject*QUESTIONS_PER_SUBJECT} / ${TOTAL_QUESTIONS}`;
  prevBtn.disabled = (currentSubject===0 && currentQ===0);
  nextBtn.textContent = (currentSubject===SUBJECT_COUNT-1 && currentQ===QUESTIONS_PER_SUBJECT-1) ? 'Finish' : 'Next';
  const prevVal = answers[currentSubject*QUESTIONS_PER_SUBJECT + currentQ];
  if(typeof prevVal === 'number'){
    const card = optionsEl.querySelector(`input[value="${prevVal}"]`);
    if(card){ card.checked = true; card.closest('.optCard')?.classList.add('selected'); }
  }
}

// navigation
prevBtn.addEventListener('click', ()=>{
  if(flagged){ showToast('Exam flagged â€” cannot continue', 'error'); return; }
  if(currentQ > 0){ currentQ--; renderQuestion(); }
  else if(currentSubject > 0){ currentSubject--; currentQ = QUESTIONS_PER_SUBJECT-1; renderQuestion(); }
});
nextBtn.addEventListener('click', ()=>{
  if(flagged){ showToast('Exam flagged â€” cannot continue', 'error'); return; }
  if(currentQ < QUESTIONS_PER_SUBJECT-1){ currentQ++; renderQuestion(); }
  else {
    if(currentSubject < SUBJECT_COUNT - 1){ currentSubject++; currentQ=0; sectionSeconds = Math.floor((10*60)/SUBJECT_COUNT); renderQuestion(); }
    else computeAndShowResults();
  }
});
submitBtn.addEventListener('click', async ()=>{
  const isLast = (currentSubject === SUBJECT_COUNT-1 && currentQ === QUESTIONS_PER_SUBJECT-1);
  const message = isLast ? 'Are you sure to submit this? This can be undone' : 'Submit exam now?';
  const ok = await showConfirm(message);
  if(!ok){ showToast('Submission canceled', 'info'); return; }
  computeAndShowResults();
});

// timers
function updateTimersUI(){ const m=Math.floor(totalSeconds/60), s=totalSeconds%60; totalTimerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; const sm=Math.floor(sectionSeconds/60), ss=sectionSeconds%60; sectionTimerEl.textContent = `${String(sm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function startTotalTimer(){ updateTimersUI(); totalTimerInterval = setInterval(()=>{ totalSeconds--; if(totalSeconds<=0){ clearInterval(totalTimerInterval); clearInterval(sectionTimerInterval); computeAndShowResults(); } updateTimersUI(); },1000); }
function startSectionTimer(){ updateTimersUI(); sectionTimerInterval = setInterval(()=>{ sectionSeconds--; if(sectionSeconds<=0){ if(currentSubject < SUBJECT_COUNT-1){ currentSubject++; currentQ=0; sectionSeconds = Math.floor((10*60)/SUBJECT_COUNT); renderQuestion(); } else computeAndShowResults(); } updateTimersUI(); },1000); }

// monitoring
const CHECK_MS = 1500, WARN_THRESHOLD = 0.10, FLAG_THRESHOLD = 0.16, GRACE_MS = 5000, MIN_LIGHT = 25;
function startMonitoring(){
  if(monitorInterval) clearInterval(monitorInterval);
  monitorInterval = setInterval(()=>{
    if(flagged) return;
    if(!examStream || examStream.getVideoTracks().length===0 || examStream.getVideoTracks()[0].readyState==='ended'){ triggerWarning('Camera disconnected'); return; }
    const cur = takeSnapshot(examCam);
    if(!cur){ triggerWarning('No frame'); return; }
    const lum = avgLuminance(cur); if(lum < MIN_LIGHT){ triggerWarning('Too dark'); return; }
    const ratio = imageDiffRatio(refImage, cur);
    if(ratio > FLAG_THRESHOLD){ handleFlag('Significant visual change detected (possible absence or different person)'); return; }
    if(ratio > WARN_THRESHOLD){ triggerWarning('Face differs from reference (suspicious)'); return; }
    clearWarning();
  }, CHECK_MS);
}

// visibility -> flag
document.addEventListener('visibilitychange', ()=> {
  if(document.hidden){
    if(!flagged && !step3El.classList.contains('hidden')){
      handleFlag('Switched tab or app (focus lost)');
    }
  }
});

// warnings + flags
function triggerWarning(reason){
  if(flagged) return;
  warned = true;
  warnEl.textContent = 'âš ï¸ Warning: Please face the camera';
  showToast('Warning: face camera or you will be flagged', 'warn', 3000);
  warnFeedback();
  if(graceTimer) clearTimeout(graceTimer);
  graceTimer = setTimeout(()=>{
    const cur = takeSnapshot(examCam);
    if(!cur){ handleFlag('No camera/frame after warning'); return; }
    const ratio = imageDiffRatio(refImage, cur);
    const lum = avgLuminance(cur);
    if(ratio > WARN_THRESHOLD || lum < MIN_LIGHT){ handleFlag('Violation persisted after warning'); } else clearWarning();
  }, GRACE_MS);
}
function clearWarning(){ warnEl.textContent = ''; if(graceTimer){ clearTimeout(graceTimer); graceTimer=null } }

function handleFlag(reason){
  if(flagged) return;
  flagged = true;
  flagEl.textContent = 'ðŸš« MALPRACTICE: Exam stopped due to suspicious behavior';
  showToast('Flagged: exam stopped', 'error', 3000);
  try{ if(navigator.vibrate) navigator.vibrate([300,120,220,120,180]); }catch(e){}
  playWarningBeef();
  if(totalTimerInterval) clearInterval(totalTimerInterval);
  if(sectionTimerInterval) clearInterval(sectionTimerInterval);
  if(monitorInterval) clearInterval(monitorInterval);
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
  Array.from(document.querySelectorAll('input[type=radio]')).forEach(i=>i.disabled=true);
  nextBtn.disabled = true; submitBtn.disabled = true; prevBtn.disabled = true;
  resultContent.innerHTML = `<div style="font-weight:800;color:var(--danger)">MALPRACTICE DETECTED</div><div style="margin-top:8px">Reason: ${reason}</div><div style="margin-top:8px">Exam stopped.</div>`;
  setStep(4);
  resultsLoader.classList.add('hidden');
  resultContent.classList.remove('hidden');
  document.getElementById('qbox').style.display='none';
}
function handleStreamEnded(reason){ console.log('Stream ended:', reason); triggerWarning('Camera disconnected or blocked'); }

// result flow
function computeAndShowResults(){
  if(flagged){ handleFlag('Flagged before submit'); return; }
  if(totalTimerInterval) clearInterval(totalTimerInterval);
  if(sectionTimerInterval) clearInterval(sectionTimerInterval);
  if(monitorInterval) clearInterval(monitorInterval);
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel){ const overall = currentSubject*QUESTIONS_PER_SUBJECT + currentQ; answers[overall] = Number(sel.value); }

  setStep(4);
  resultContent.classList.add('hidden');
  resultsLoader.classList.remove('hidden');

  const DURATION = 30000;
  const start = Date.now();
  percentText.textContent = '0%';
  let progInterval = setInterval(()=>{
    const elapsed = Date.now() - start;
    let pct = Math.min(100, Math.floor((elapsed / DURATION) * 100));
    percentText.textContent = `${pct}%`;
    if(elapsed >= DURATION){
      clearInterval(progInterval);
      resultsLoader.classList.add('hidden');
      let perSub = [], totalCorrect = 0;
      for(let s=0;s<SUBJECT_COUNT;s++){
        let correct = 0;
        for(let q=0;q<QUESTIONS_PER_SUBJECT;q++){
          const idx = s*QUESTIONS_PER_SUBJECT + q;
          const selVal = answers[idx];
          if(typeof selVal==='number' && selVal === userQuestionPool[s][q].a) correct++;
        }
        perSub.push(correct); totalCorrect += correct;
      }
      const totalMarksRaw = totalCorrect * MARK_PER_Q;
      const totalMarks = Math.round(totalMarksRaw * 10) / 10;
      let html = '';
      const passMark = 40;
      if(totalMarks >= passMark){
        html += `<div class="congratsCard"><div class="congratsIcon"><i class="fa-solid fa-check"></i></div><div><div style="font-weight:900;color:var(--accent-700);font-size:18px">Congratulations</div><div style="margin-top:6px" class="muted">You passed the exam</div></div></div>`;
      } else {
        html += `<div class="congratsCard"><div class="congratsIcon" style="background:linear-gradient(135deg,#ef4444,#dc2626)"><i class="fa-solid fa-xmark"></i></div><div><div style="font-weight:900;color:var(--danger);font-size:18px">Result</div><div style="margin-top:6px" class="muted">You did not meet the pass mark</div></div></div>`;
      }

      html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px"><div style="font-weight:800">ATech ICT â€” CBT Result</div>`;
      if(refDataUrl){
        html += `<div style="display:flex;align-items:center;gap:8px"><div class="muted" style="font-size:12px">Reference:</div><img src="${refDataUrl}" alt="reference" style="width:96px;height:72px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);object-fit:cover"></div>`;
      }
      html += `</div>`;

      html += `<div style="margin-top:12px;font-weight:800">Candidate â€” ${escapeHtml(nameInput.value)}</div><div style="margin-top:8px">Per-subject:</div><ul>`;
      for(let s=0;s<SUBJECT_COUNT;s++){
        const marksSub = Math.round(perSub[s] * MARK_PER_Q * 10) / 10;
        html += `<li>${subjects[s].name}: ${perSub[s]} / ${QUESTIONS_PER_SUBJECT} (${marksSub} marks)</li>`;
      }
      html += `</ul><div style="margin-top:8px"><strong>Total: ${totalMarks} / 100</strong></div>`;

      let grade='';
      if(totalMarks>=80) grade='Distinction'; else if(totalMarks>=65) grade='Upper Class'; else if(totalMarks>=50) grade='Lower Class'; else if(totalMarks>=40) grade='Pass'; else if(totalMarks>=30) grade='Play Class'; else grade='Failed â€” Retry';
      html += `<div style="margin-top:8px"><strong>Grade: ${grade}</strong></div>`;

      html += `<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="printBtn" class="btn print"><i class="fa-solid fa-print"></i> Print Result</button></div>`;

      resultContent.innerHTML = html;
      resultContent.classList.remove('hidden');
      document.getElementById('qbox').style.display='none';

      const printBtn = document.getElementById('printBtn');
      if(printBtn){
        printBtn.addEventListener('click', ()=> printResults({
          candidate: nameInput.value,
          perSubject: perSub,
          totalMarks,
          grade,
          refDataUrl
        }));
      }
    }
  }, 300);
}

// escape helper
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

// sha256
async function sha256Hex(msg){
  try{
    const data = new TextEncoder().encode(msg);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }catch(e){
    let s=0; for(let i=0;i<msg.length;i++) s=(s+msg.charCodeAt(i))%1000000000;
    return s.toString(16);
  }
}

// Print + QR (now using api.qrserver.com)
async function printResults({candidate, perSubject, totalMarks, grade, refDataUrl}){
  const payload = {
    candidate: (candidate||'').slice(0,40),
    perSubject,
    totalMarks,
    grade,
    timestamp: Date.now()
  };
  const payloadStr = JSON.stringify(payload);
  const hex = await sha256Hex(payloadStr);
  const verCode = hex.slice(0,12).toUpperCase();

  // Use api.qrserver.com to generate QR of the compact JSON (should be reliable)
  const qrPayload = { candidate: payload.candidate, totalMarks, grade, verification: verCode, ts: payload.timestamp };
  const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=' + encodeURIComponent(JSON.stringify(qrPayload));

  const styles = `
    body{font-family:Inter,system-ui,Roboto,-apple-system,"Segoe UI",Arial;color:#052e14;padding:20px;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .title{font-weight:800;font-size:20px;color:#127338}
    .refimg{width:120px;height:90px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);object-fit:cover}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid #eee;text-align:left}
    .total{font-weight:900;margin-top:12px;font-size:16px}
    .smallmuted{color:#4b5563;font-size:13px}
    .qrwrap{display:flex;justify-content:center;margin-top:16px}
    .vercode{margin-top:8px;text-align:center;font-weight:800}
  `;
  let subjRows = '';
  for(let s=0;s<SUBJECT_COUNT;s++){
    const marksSub = Math.round(perSubject[s] * MARK_PER_Q * 10) / 10;
    subjRows += `<tr><td>${escapeHtml(subjects[s].name)}</td><td>${perSubject[s]} / ${QUESTIONS_PER_SUBJECT}</td><td>${marksSub}</td></tr>`;
  }
  const html = `
    <html>
      <head><title>ATech ICT â€” Result</title><style>${styles}</style></head>
      <body>
        <div class="header">
          <div><div class="title">ATech ICT</div><div class="smallmuted">CBT Result</div></div>
          ${refDataUrl? `<img src="${refDataUrl}" class="refimg" alt="reference">` : ''}
        </div>
        <div>Candidate: <strong>${escapeHtml(candidate)}</strong></div>
        <table>
          <thead><tr><th>Subject</th><th>Score (correct)</th><th>Marks</th></tr></thead>
          <tbody>${subjRows}</tbody>
        </table>
        <div class="total">Total: ${totalMarks} / 100</div>
        <div style="margin-top:6px">Grade: <strong>${escapeHtml(grade)}</strong></div>

        <div class="qrwrap">
          <div>
            <img src="${qrUrl}" alt="QR code" style="width:180px;height:180px;border:1px solid #eee;padding:6px;background:#fff;border-radius:8px">
            <div class="vercode">Verification: <span style="font-family:monospace">${verCode}</span></div>
            <div style="margin-top:8px" class="smallmuted">Scan QR to view/embed this result (QR contains basic result & verification).</div>
          </div>
        </div>

        <div style="margin-top:12px" class="smallmuted">Use your browser's Print function to save or print this result (menu â†’ Print).</div>
      </body>
    </html>
  `;
  try{
    const win = window.open('','_blank','width=820,height=900');
    if(!win){ showToast('Unable to open print window (popup blocked?)', 'error', 4000); return; }
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
  }catch(e){
    showToast('Unable to open print window (popup blocked?)', 'error', 4000);
  }
}

// retry
retryBtn.addEventListener('click', ()=> location.reload());

// init
function prepareOnLoad(){ userQuestionPool = subjects.map(s => shuffleArray(s.questions.map(q => ({...q}))) ); showToast('Welcome â€” enter name to begin', 'info', 1200); }
prepareOnLoad();
</script>
</body>
</html>
