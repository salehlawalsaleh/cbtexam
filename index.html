<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CBT Exam â€” Lightweight (Improved Detection)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.08);width:92%;max-width:420px;text-align:center}
  video{width:320px;height:240px;border-radius:8px;border:3px solid #0a84ff;background:#000;object-fit:cover}
  canvas{display:none}
  input{width:86%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
  button{background:#0a84ff;color:#fff;border:0;padding:10px 14px;border-radius:6px;margin-top:10px;cursor:pointer}
  .small{font-size:13px;color:#555}
  #faceStatus{font-weight:700;margin-top:8px}
  #warning{color:#e67e22;font-weight:700;margin-top:8px}
  #flagged{color:#c026d3;font-weight:800;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h2>Welcome to CBT Exams</h2>
    <p class="small">Lightweight detection â€” improved fallback</p>

    <div id="step-welcome">
      <input id="name" placeholder="Enter your name" />
      <br>
      <button id="proceed">Proceed</button>
    </div>

    <div id="step-face" style="display:none">
      <h3>Face verification</h3>
      <video id="preview" autoplay muted playsinline></video>
      <canvas id="fx" width="320" height="240"></canvas>
      <div id="faceStatus">Detecting face...</div>
      <div class="small" id="debug"></div>
      <button id="startExam" disabled>Start Exam</button>
      <button id="back">Back</button>
    </div>

    <div id="step-exam" style="display:none">
      <h3>Exam</h3>
      <div id="user"></div>
      <video id="examCam" autoplay muted playsinline></video>
      <div id="warn" style="color:#e67e22;font-weight:700"></div>
      <div id="flag" style="color:red;font-weight:800"></div>
      <div id="questions"></div>
      <div style="margin-top:10px"><button id="submit">Submit</button></div>
      <div id="result" style="margin-top:10px;font-weight:700"></div>
    </div>
  </div>

<script>
// Improved detection: try FaceDetector -> fallback to motion/contrast frame-diff
const proceed = document.getElementById('proceed');
const preview = document.getElementById('preview');
const fx = document.getElementById('fx');
const faceStatus = document.getElementById('faceStatus');
const debug = document.getElementById('debug');
const startExamBtn = document.getElementById('startExam');
const back = document.getElementById('back');
const stepWelcome = document.getElementById('step-welcome');
const stepFace = document.getElementById('step-face');
const stepExam = document.getElementById('step-exam');
const nameInput = document.getElementById('name');
const userDiv = document.getElementById('user');
const examCam = document.getElementById('examCam');
const warn = document.getElementById('warn');
const flag = document.getElementById('flag');
const questionsDiv = document.getElementById('questions');
const submitBtn = document.getElementById('submit');
const result = document.getElementById('result');

let previewStream=null, detector=null;
let faceDetected=false, stableCount=0;
let detectionTimer=null;
let monitoringTimer=null;
let warned=false, flagged=false;

const QUESTIONS = [
  // 20 sample (short) - you can replace later
  "What is 2+2?",
  "What is capital of Nigeria?",
  "What is plural of 'mouse'?",
  "Who is head of state?",
  "Spell 'separate'.",
  "5 x 5 = ?",
  "What colour is the Nigerian flag?",
  "Define 'citizen'.",
  "What does NPF stand for?",
  "What is the opposite of 'hot'?",
  "10 + 15 = ?",
  "Who makes laws in Nigeria?",
  "What is democracy?",
  "Name a security agency.",
  "What is 'integrity'?",
  "What is 100 Ã· 4?",
  "What is the plural of 'child'?",
  "Who enforces law?",
  "What is basic right of voters?",
  "What is an example of civic duty?"
];

// build question inputs
function buildQuestions(){
  questionsDiv.innerHTML = '';
  QUESTIONS.forEach((q,i)=>{
    const d = document.createElement('div');
    d.style.marginTop = '8px';
    d.innerHTML = `<div class="small"><b>Q${i+1}.</b> ${q}</div>
      <input id="ans${i}" placeholder="Answer..." />`;
    questionsDiv.appendChild(d);
  });
}

// small beep
function beep(ms=180,f=700){
  try{
    const C = new (window.AudioContext||window.webkitAudioContext)();
    const o = C.createOscillator(); const g = C.createGain();
    o.connect(g); g.connect(C.destination); o.type='sine'; o.frequency.value=f;
    g.gain.setValueAtTime(0.2, C.currentTime); o.start(); o.stop(C.currentTime + ms/1000);
  }catch(e){}
}

// helper: draw frame to canvas and get ImageData
function getFrameData(videoEl){
  const ctx = fx.getContext('2d');
  try{
    ctx.drawImage(videoEl,0,0,fx.width,fx.height);
    return ctx.getImageData(0,0,fx.width,fx.height);
  }catch(e){
    return null;
  }
}

// compute grayscale average intensity and simple face-region variance
function frameDiffRatio(imgA, imgB){
  if(!imgA || !imgB) return 0;
  let diff = 0, total = imgA.data.length/4;
  for(let i=0, len=imgA.data.length; i<len; i+=4){
    // compute luminance for both
    const y1 = 0.299*imgA.data[i] + 0.587*imgA.data[i+1] + 0.114*imgA.data[i+2];
    const y2 = 0.299*imgB.data[i] + 0.587*imgB.data[i+1] + 0.114*imgB.data[i+2];
    diff += Math.abs(y1 - y2);
  }
  // normalize
  return diff / (total * 255);
}

// Try to create FaceDetector if available
if('FaceDetector' in window){
  try{
    detector = new FaceDetector({fastMode:true, maxDetectedFaces:1});
    console.log('FaceDetector available');
  }catch(e){ detector = null; console.warn('FaceDetector init failed', e); }
} else {
  console.log('FaceDetector not supported â€” will use fallback');
}

// start cameras + detection
proceed.addEventListener('click', async ()=>{
  const name = nameInput.value.trim();
  if(!name) return alert('Enter your name');
  stepWelcome.style.display='none';
  stepFace.style.display='block';
  buildQuestions();

  try{
    previewStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    preview.srcObject = previewStream;
  }catch(e){
    alert('Camera permission required');
    stepFace.style.display='none'; stepWelcome.style.display='block';
    return;
  }

  // detection loop: try FaceDetector first
  if(detector){
    faceStatus.textContent = 'Using built-in FaceDetector...';
    detectionTimer = setInterval(async ()=>{
      try{
        const faces = await detector.detect(preview);
        debug.innerText = `faces:${faces.length}`;
        if(faces && faces.length>0){
          stableCount++;
          faceStatus.textContent = `âœ… Face detected (${stableCount})`;
        } else {
          stableCount = 0;
          faceStatus.textContent = 'âŒ No face detected';
        }
        if(stableCount >= 1){
          faceDetected = true;
          startExamBtn.disabled = false;
        } else startExamBtn.disabled = true;
      }catch(e){
        console.warn('detector err', e);
      }
    },700);
  } else {
    // Fallback motion-based detection
    faceStatus.textContent = 'Fallback: motion detection (no model)';
    let prev = null;
    let stable = 0;
    detectionTimer = setInterval(()=>{
      const frame = getFrameData(preview);
      if(!frame){ faceStatus.textContent='âŒ Frame read error'; return; }
      const ratio = prev ? frameDiffRatio(frame, prev) : 0;
      prev = frame;
      debug.innerText = `motion:${ratio.toFixed(3)}`;
      // threshold tuned for phone/webcam: if motion > 0.012 => presence (someone moving face)
      if(ratio > 0.012){
        stable++; faceStatus.textContent = `âœ… Motion detected (${stable})`;
      } else {
        stable = 0; faceStatus.textContent = 'âŒ Still / no motion';
      }
      if(stable >= 1){
        faceDetected = true; startExamBtn.disabled = false;
      } else { faceDetected = false; startExamBtn.disabled = true; }
    },700);
  }
});

// Back button
back.addEventListener('click', ()=>{
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  clearInterval(detectionTimer);
  stepFace.style.display='none'; stepWelcome.style.display='block';
  faceStatus.textContent='Detecting face...'; debug.innerText='';
  startExamBtn.disabled = true;
});

// Start exam (after pressing Start)
startExamBtn.addEventListener('click', async ()=>{
  if(!faceDetected) return alert('Face not detected yet');
  stepFace.style.display='none'; stepExam.style.display='block';
  userDiv.innerText = 'Candidate: ' + nameInput.value;
  // start exam camera
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    examCam.srcObject = s;
  }catch(e){
    alert('Exam camera failed');
  }
  // start monitoring with same hybrid approach
  startMonitoring();
});

// monitoring while exam runs
function startMonitoring(){
  warned=false; flagged=false; warn.innerText=''; flag.innerText='';
  if(detectionTimer) clearInterval(detectionTimer);
  // use detector if available
  let prev=null;
  monitoringTimer = setInterval(async ()=>{
    if(flagged) return;
    try{
      if(detector){
        const faces = await detector.detect(examCam);
        debug.innerText = `faces:${faces.length}`;
        if(!faces || faces.length===0){
          handleViolation('no-face');
        } else {
          // face found -> reset warning UI
          warn.innerText=''; // clear warning
        }
      } else {
        // fallback motion
        const frame = getFrameData(examCam);
        if(!frame){ console.warn('no frame'); return; }
        const ratio = prev ? frameDiffRatio(frame, prev) : 0;
        prev = frame;
        debug.innerText = `motion:${ratio.toFixed(3)}`;
        if(ratio < 0.008){ // very low motion -> likely turned away / static
          handleViolation('low-motion');
        } else {
          warn.innerText = '';
        }
      }
    }catch(e){ console.warn('monitor err', e); }
  },1200);
}

// violation handler: first -> warning, second -> flagged
function handleViolation(type){
  if(flagged) return;
  if(!warned){
    warned=true;
    beep(300,900);
    warn.innerText = 'âš ï¸ Warning: Please face the camera';
    console.log('Warning:', type);
  } else {
    // second time -> flagged
    flagged=true;
    beep(900,300);
    flag.innerText = 'ðŸš« FLAGGED OUT â€” Exam stopped';
    // disable inputs/questions
    Array.from(document.querySelectorAll('input')).forEach(i=>i.disabled=true);
    console.log('Flagged:', type);
  }
}

// simple submit
submitBtn.addEventListener('click', ()=>{
  // compute simple scoring: exact string match lowercased for demo
  let correct=0;
  QUESTIONS.forEach((q,i)=>{
    const ans = (document.getElementById('ans'+i) || {}).value || '';
    if(ans.trim().toLowerCase() === q.trim().toLowerCase()) correct++;
  });
  const scaled = Math.round((correct / QUESTIONS.length) * 25);
  result.innerText = `Result: ${scaled}/25 (${Math.round((scaled/25)*100)}%)`;
  // stop monitor
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  if(monitoringTimer) clearInterval(monitoringTimer);
});

// Build question inputs initially so user won't wait later
(function init(){
  buildQuestionsUI();
})();

function buildQuestionsUI(){
  questionsDiv.innerHTML = '';
  QUESTIONS.forEach((q,i)=>{
    const d = document.createElement('div');
    d.style.marginTop='8px';
    d.innerHTML = `<div class="small"><b>Q${i+1}.</b> ${q}</div>
      <input id="ans${i}" placeholder="Answer..." />`;
    questionsDiv.appendChild(d);
  });
}

</script>
</body>
</html>
