<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>CBT Exam â€” ATech ICT Solution (Strict Monitoring)</title>
<meta name="theme-color" content="#16A34A" />
<link rel="icon" href="data:," />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f0fdf4; --card:#ffffff; --accent:#16A34A; --accent-600:#15803d;
    --muted:#4b5563; --soft:#ecfdf0; --warn:#f59e0b; --danger:#dc2626;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Roboto,-apple-system,"Segoe UI",Arial;
    background:linear-gradient(180deg,#f6fff6 0%, #effff0 100%);
    -webkit-font-smoothing:antialiased;color:#052e14;
    display:flex;align-items:center;justify-content:center;padding:12px;
  }
  .wrap{width:100%;max-width:760px}
  .card{
    background:var(--card);border-radius:14px;overflow:hidden;
    box-shadow:0 12px 30px rgba(6,95,70,0.08);border:1px solid rgba(6,95,70,0.03);
  }
  .header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;background:linear-gradient(90deg,#f0fdf4,#f6fff6)}
  .brand{display:flex;flex-direction:column}
  .title{font-weight:700;font-size:18px;color:var(--accent-600)}
  .subtitle{font-size:13px;color:var(--muted)}
  .helpBtn{background:#25D366;color:white;padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700}
  .content{display:grid;grid-template-columns:1fr;gap:0;padding:16px}
  @media(min-width:880px){ .content{grid-template-columns:1fr 300px} }
  .left{padding:6px 12px}
  .right{padding:12px;border-left:1px solid rgba(6,95,70,0.03);background:linear-gradient(180deg,#fbfff9, #f8fff6)}
  .card-section{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6f6ea;font-size:15px}
  .row{display:flex;gap:10px;align-items:center}
  .videoWrap{display:flex;justify-content:center;margin-top:12px}
  video{width:320px;height:240px;border-radius:12px;border:4px solid rgba(22,163,74,0.08);background:#000;object-fit:cover}
  .status{font-weight:700;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}
  .warning{color:var(--warn);font-weight:800;margin-top:8px}
  .flag{color:var(--danger);font-weight:900;margin-top:8px}
  .qbox{margin-top:12px;padding:12px;border-radius:12px;background:var(--soft)}
  .opts label{display:block;margin:8px 0;padding:10px;border-radius:10px;border:1px solid #e6f4ea;cursor:pointer}
  .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .timer{font-weight:800;color:var(--accent-600)}
  .progressBar{height:8px;background:#e6f9ea;border-radius:8px;overflow:hidden;margin-top:8px}
  .progressFill{height:100%;background:linear-gradient(90deg,var(--accent-600),#10b981);width:0%;transition:width 400ms ease}
  .resultBox{padding:12px;background:#ecfdf4;border-radius:10px;margin-top:12px}
  .footer{padding:12px;text-align:center;font-size:13px;color:var(--muted);background:transparent;border-top:1px solid rgba(6,95,70,0.03)}
  button{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 6px 18px rgba(22,163,74,0.10)}
  button[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
  .smallBtn{background:transparent;border:1px solid rgba(6,95,70,0.08);color:var(--accent-600);padding:8px 10px;border-radius:8px}
  .center{display:flex;align-items:center;gap:8px}
  .hidden{display:none}
  @media(max-width:420px){ video{width:280px;height:200px} .header{padding:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="appTitle">
      <div class="header">
        <div class="brand">
          <div id="appTitle" class="title">CBT Exam â€” ATech ICT Solution</div>
          <div class="subtitle">Mobile-only â€¢ Strict monitoring â€¢ 20 questions â€¢ 20 minutes</div>
        </div>
        <div><a class="helpBtn" href="https://wa.me/2348145415083" target="_blank" rel="noopener">Help / Support</a></div>
      </div>

      <div class="content">
        <div class="left">
          <!-- Welcome -->
          <div id="welcomeCard" class="card-section" aria-live="polite">
            <label class="muted">Enter your full name</label>
            <input id="nameInput" placeholder="e.g. Musa Ahmed" aria-label="Full name">
            <div style="margin-top:12px" class="row">
              <button id="proceedBtn">Proceed</button>
              <div class="muted" style="flex:1">Allow camera when prompted. Strict monitoring enabled.</div>
            </div>
          </div>

          <!-- Capture reference -->
          <div id="captureCard" class="card-section hidden" aria-hidden="true">
            <h3 style="margin:0 0 8px 0">1 â€¢ Capture reference</h3>
            <div class="videoWrap"><video id="preview" autoplay muted playsinline></video></div>
            <div id="captureStatus" class="status">Initializing camera...</div>
            <div style="margin-top:10px" class="row">
              <button id="captureBtn" disabled>Capture Reference Photo</button>
              <button id="retakeBtn" class="smallBtn hidden">Retake</button>
              <div class="muted" style="flex:1">Reference photo will be strict baseline â€” large changes = malpractice.</div>
            </div>
          </div>

          <!-- Start -->
          <div id="startCard" class="card-section hidden" aria-hidden="true">
            <h3 style="margin:0 0 8px 0">2 â€¢ Start exam</h3>
            <div class="muted">Candidate: <span id="displayName"></span></div>
            <div style="margin-top:12px" class="row">
              <button id="startBtn" disabled>Start Exam</button>
              <button id="backToCapture" class="smallBtn">Back</button>
            </div>
          </div>

          <!-- Exam -->
          <div id="examCard" class="card-section hidden" aria-hidden="true">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Candidate: <span id="candName"></span></div>
              <div style="text-align:right">
                <div class="timer">Total: <span id="totalTimer">20:00</span></div>
                <div class="muted">Section: <span id="sectionTimer">05:00</span></div>
              </div>
            </div>

            <div class="videoWrap" style="margin-top:12px"><video id="examCam" autoplay muted playsinline></video></div>
            <div id="warnMsg" class="warning" role="alert"></div>
            <div id="flagMsg" class="flag" role="alert"></div>

            <div class="qbox" id="qbox">
              <div id="qmeta" style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:800" id="qSubject"></div>
                <div style="font-size:12px;color:var(--muted)" id="qProgress"></div>
              </div>
              <div id="qText" style="margin-top:10px;font-weight:700"></div>
              <div id="options" style="margin-top:10px"></div>

              <div class="progressBar" aria-hidden="true">
                <div id="progressFill" class="progressFill"></div>
              </div>

              <div class="controls">
                <button id="nextBtn">Next</button>
                <button id="submitBtn">Submit Exam</button>
              </div>
            </div>

            <div id="resultPanel" class="hidden" aria-live="polite">
              <div class="resultBox" id="resultBox"></div>
              <div style="display:flex;justify-content:flex-end;margin-top:10px">
                <button id="retryBtn">Retry</button>
              </div>
            </div>
          </div>

        </div>

        <aside class="right">
          <div class="card-section">
            <div class="muted">Exam Rules</div>
            <ul class="muted" style="margin-top:8px">
              <li>20 questions â€” 5 per subject (English â†’ Math â†’ Civic â†’ Nigerian Security)</li>
              <li>Each subject = 5 minutes (auto-advance)</li>
              <li>Total = 20 minutes (auto submit)</li>
              <li>Each correct = 5 marks; total = 100</li>
              <li><strong>Strict monitoring:</strong> 1st violation = immediate warning; if not corrected within <strong>5 seconds</strong> â†’ flagged out.</li>
            </ul>
          </div>

          <div class="card-section" style="margin-top:12px">
            <div class="muted">Debug / Logs</div>
            <pre id="log" class="muted" style="height:160px;overflow:auto;margin-top:8px;background:#fff;padding:8px;border-radius:8px"></pre>
          </div>
        </aside>
      </div>

      <div class="footer">Â© ATech ICT Solution â€¢ <a href="https://wa.me/2348145415083" target="_blank" rel="noopener" style="color:var(--accent-600)">wa.me/08145415083</a></div>
    </div>
  </div>

<script>
/* Strict monitoring CBT â€” modern design
   - strict: immediate warning on violation, graceWindow (5s) to fix, otherwise flag
   - FaceDetector preferred; fallback = image diff sampling
   - mobile-first, green theme, beep sounds
*/

// QUESTIONS & SUBJECTS (same structure)
const subjects = [
  { name:'English', questions:[
    {q:'Sentence is a group of ...', opts:['A. World','B. Word','C. Alphabet'], a:1},
    {q:'Antonym of "hot" is ...', opts:['A. Warm','B. Cold','C. Mild'], a:1},
    {q:'Plural of "child"?', opts:['A. Childs','B. Childes','C. Children'], a:2},
    {q:'Which is a noun?', opts:['A. Run','B. Apple','C. Quickly'], a:1},
    {q:'Synonym of "happy"?', opts:['A. Sad','B. Joyful','C. Angry'], a:1}
  ]},
  { name:'Mathematics', questions:[
    {q:'5 + 5 = ?', opts:['A. 9','B. 10','C. 11'], a:1},
    {q:'12 Ã· 3 = ?', opts:['A. 3','B. 4','C. 5'], a:1},
    {q:'7 Ã— 6 = ?', opts:['A. 42','B. 36','C. 48'], a:0},
    {q:'10 - 4 = ?', opts:['A. 6','B. 5','C. 7'], a:0},
    {q:'3 Ã— 3 = ?', opts:['A. 6','B. 9','C. 8'], a:1}
  ]},
  { name:'Civic Education', questions:[
    {q:'Nigeria gained independence in ...', opts:['A. 1960','B. 1970','C. 1957'], a:0},
    {q:'A democratic responsibility is ...', opts:['A. Voting','B. Looting','C. Forcing'], a:0},
    {q:'Who is head of state?', opts:['A. Governor','B. President','C. Mayor'], a:1},
    {q:'One right of a citizen is ...', opts:['A. Vote','B. Bomb','C. Rob'], a:0},
    {q:'Legislative arm is ...', opts:['A. Judiciary','B. Executive','C. Legislature'], a:2}
  ]},
  { name:'Nigerian Security', questions:[
    {q:'Which agency handles internal security?', opts:['A. NCDC','B. Army','C. Police'], a:2},
    {q:'Measure to improve security?', opts:['A. Community policing','B. Ignore crime','C. Support criminals'], a:0},
    {q:'What is "integrity"?', opts:['A. Honesty','B. Bribery','C. Secrecy'], a:0},
    {q:'What helps emergency response?', opts:['A. Good roads','B. Bad governance','C. Noise'], a:0},
    {q:'Who coordinates national security policy?', opts:['A. Local chief','B. President','C. Teacher'], a:1}
  ]}
];

// DOM refs
const proceedBtn = document.getElementById('proceedBtn');
const nameInput = document.getElementById('nameInput');
const captureCard = document.getElementById('captureCard');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const preview = document.getElementById('preview');
const captureStatus = document.getElementById('captureStatus');
const startCard = document.getElementById('startCard');
const startBtn = document.getElementById('startBtn');
const backToCapture = document.getElementById('backToCapture');
const displayName = document.getElementById('displayName');
const candName = document.getElementById('candName');
const examCard = document.getElementById('examCard');
const examCam = document.getElementById('examCam');
const warnMsg = document.getElementById('warnMsg');
const flagMsg = document.getElementById('flagMsg');
const qSubject = document.getElementById('qSubject');
const qText = document.getElementById('qText');
const optionsEl = document.getElementById('options');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const totalTimerEl = document.getElementById('totalTimer');
const sectionTimerEl = document.getElementById('sectionTimer');
const qProgress = document.getElementById('qProgress');
const progressFill = document.getElementById('progressFill');
const logEl = document.getElementById('log');
const resultPanel = document.getElementById('resultPanel');
const resultBox = document.getElementById('resultBox');
const retryBtn = document.getElementById('retryBtn');
const welcomeCard = document.getElementById('welcomeCard');
const captureCardEl = document.getElementById('captureCard');
const startCardEl = document.getElementById('startCard');
const examCardEl = document.getElementById('examCard');

// state
let previewStream = null, examStream = null;
let refImage = null, refHash = null;
let warningGiven = false, flagged = false, warnCount = 0, flagCount = 0;
let totalSeconds = 20*60, sectionSeconds = 5*60;
let totalTimerInterval = null, sectionTimerInterval = null, monitorInterval = null, graceTimer = null;
let currentSubject = 0, currentQ = 0;
let answers = new Array(20).fill(null);

// FaceDetector if available
let FaceDetectorClass = ('FaceDetector' in window) ? window.FaceDetector : null;
let detector = null;
try{ if(FaceDetectorClass) detector = new FaceDetectorClass({fastMode:true, maxDetectedFaces:1}); }catch(e){ detector = null; }

// canvas helper
const canvas = document.createElement('canvas'); canvas.width = 320; canvas.height = 240;
const ctx = canvas.getContext('2d');

// image snapshot + quick hash & diff sampling
function takeSnapshot(videoEl){
  try{
    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
    return ctx.getImageData(0,0,canvas.width,canvas.height);
  }catch(e){ return null; }
}
function quickHash(img){
  if(!img) return '';
  let s = 0;
  for(let i=0;i<img.data.length;i+=4*128) s = (s + img.data[i] + img.data[i+1] + img.data[i+2]) % 100000;
  return String(s);
}
function imageDiffRatio(a,b){
  if(!a||!b) return 1;
  let diff=0; const step=12; const len=a.data.length;
  for(let i=0;i<len;i+=4*step){
    diff += Math.abs(a.data[i]-b.data[i]) + Math.abs(a.data[i+1]-b.data[i+1]) + Math.abs(a.data[i+2]-b.data[i+2]);
  }
  const max = (len/(4*step)) * 3 * 255;
  return diff / max;
}

// audio cues
function beep(ms=220,f=700){ try{ const A=new (window.AudioContext||window.webkitAudioContext)(); const o=A.createOscillator(); const g=A.createGain(); o.connect(g); g.connect(A.destination); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0.16,A.currentTime); o.start(); o.stop(A.currentTime + ms/1000);}catch(e){} }

// logging
function log(msg){ logEl.textContent = new Date().toLocaleTimeString() + ' â€” ' + msg + '\n' + logEl.textContent; }

// UI helpers
function show(el){ el.classList.remove('hidden'); el.style.display='block'; }
function hide(el){ el.classList.add('hidden'); el.style.display='none'; }

// PROCEED -> open preview camera
proceedBtn.addEventListener('click', async ()=>{
  const name = nameInput.value.trim();
  if(!name) return alert('Enter your name');
  welcomeCard.style.display = 'none'; welcomeCard.classList.add('hidden');
  captureCardEl.style.display = 'block'; captureCardEl.classList.remove('hidden');
  displayName.textContent = name; document.getElementById('displayName').textContent = name;
  try{
    previewStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    preview.srcObject = previewStream;
    captureStatus.textContent = 'Camera started. Align face and capture a clear reference photo.';
    captureBtn.disabled = false;
    log('Preview camera started');
  }catch(e){
    alert('Camera permission is required. Allow then reload.');
  }
});

// capture reference
captureBtn.addEventListener('click', ()=>{
  const img = takeSnapshot(preview);
  if(!img) return alert('Capture failed â€” try again.');
  refImage = img; refHash = quickHash(img);
  captureStatus.textContent = 'Reference captured. If not clear, retake.';
  retakeBtn.classList.remove('hidden'); startBtn.disabled = false;
  beep(200,900);
  // show start block
  startCardEl.style.display = 'block'; startCardEl.classList.remove('hidden');
  log('Reference captured (hash:'+refHash+')');
});

// retake
retakeBtn.addEventListener('click', ()=>{
  refImage = null; refHash = null; captureStatus.textContent = 'Reference cleared. Capture again.';
  retakeBtn.classList.add('hidden'); startBtn.disabled = true;
  log('Reference cleared');
});

// start exam
startBtn.addEventListener('click', async ()=>{
  if(!refImage) return alert('Please capture reference photo first.');
  captureCardEl.style.display='none'; startCardEl.style.display='none';
  examCardEl.style.display='block';
  candName.textContent = nameInput.value.trim();
  try{
    examStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    examCam.srcObject = examStream;
    log('Exam camera started');
  }catch(e){
    alert('Exam camera error. Allow camera and retry.');
    location.reload();
    return;
  }
  // init state
  totalSeconds = 20*60; sectionSeconds = 5*60;
  currentSubject = 0; currentQ = 0;
  answers = new Array(20).fill(null);
  warningGiven = false; flagged = false; warnCount = 0; flagCount = 0;
  updateTimersUI(); renderQuestion();
  startTotalTimer(); startSectionTimer();
  startStrictMonitoring();
});

// render question
function renderQuestion(){
  const subj = subjects[currentSubject];
  const q = subj.questions[currentQ];
  qSubject.textContent = subj.name;
  qText.textContent = q.q;
  optionsEl.innerHTML = '';
  q.opts.forEach((opt, idx)=>{
    const id = `opt_${currentSubject}_${currentQ}_${idx}`;
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="opt" id="${id}" value="${idx}"> ${opt}`;
    optionsEl.appendChild(label);
  });
  qProgress.textContent = `Q ${currentQ+1}/5 â€¢ Subject ${currentSubject+1}/${subjects.length}`;
  const overallIndex = currentSubject*5 + currentQ;
  const filled = answers.filter(a=>a!==null).length;
  const progressPct = Math.round((filled / 20) * 100);
  progressFill.style.width = progressPct + '%';
}

// next button
nextBtn.addEventListener('click', ()=>{
  if(flagged) return alert('Exam flagged out â€” cannot continue');
  const sel = document.querySelector('input[name="opt"]:checked');
  const overall = currentSubject*5 + currentQ;
  if(sel) answers[overall] = Number(sel.value);
  if(currentQ < 4){ currentQ++; renderQuestion(); }
  else {
    if(currentSubject < subjects.length -1){
      currentSubject++; currentQ = 0; sectionSeconds = 5*60; renderQuestion();
    } else computeAndShowResults();
  }
});

// submit manual
submitBtn.addEventListener('click', ()=> {
  if(confirm('Submit exam now?')) computeAndShowResults();
});

// timers
function updateTimersUI(){
  const tm = Math.floor(totalSeconds/60), ts = totalSeconds%60;
  totalTimerEl.textContent = `${String(tm).padStart(2,'0')}:${String(ts).padStart(2,'0')}`;
  const sm = Math.floor(sectionSeconds/60), ss = sectionSeconds%60;
  sectionTimerEl.textContent = `${String(sm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function startTotalTimer(){
  updateTimersUI();
  totalTimerInterval = setInterval(()=>{
    totalSeconds--; updateTimersUI();
    if(totalSeconds <= 0){ clearInterval(totalTimerInterval); clearInterval(sectionTimerInterval); computeAndShowResults(); }
  },1000);
}
function startSectionTimer(){
  updateTimersUI();
  sectionTimerInterval = setInterval(()=>{
    sectionSeconds--; updateTimersUI();
    if(sectionSeconds <= 0){
      if(currentSubject < subjects.length -1){
        currentSubject++; currentQ = 0; sectionSeconds = 5*60; renderQuestion();
      } else computeAndShowResults();
    }
  },1000);
}

// STRICT monitoring logic:
// - interval 1500ms
// - if FaceDetector available: detect face bounding box -> if none => immediate warning; if center deviation > threshold => immediate warning
// - if fallback: compute imageDiffRatio(refImage, current). If > highThreshold => immediate flag; if > warnThreshold => warn (graceTimer 5s), if still above after grace => flag
// thresholds tuned strict:
//   warnThreshold = 0.10  (suspicious)  -> immediate warning; if not corrected in 5s -> flag
//   flagThreshold = 0.14  (major change) -> immediate flag

const CHECK_INTERVAL = 1500;
const WARN_THRESHOLD = 0.10;
const FLAG_THRESHOLD = 0.14;
const GRACE_MS = 5000;

function startStrictMonitoring(){
  if(monitorInterval) clearInterval(monitorInterval);
  monitorInterval = setInterval(async ()=>{
    if(flagged) return;
    try{
      // prefer FaceDetector if available
      if(detector){
        const faces = await detector.detect(examCam).catch(()=>[]);
        log('detector faces:'+ (faces ? faces.length : 0));
        if(!faces || faces.length === 0){
          triggerWarning('Face not detected by FaceDetector');
        } else {
          // check face center deviation relative to video center
          const box = faces[0].boundingBox;
          const faceCenterX = box.x + box.width/2;
          const videoCenterX = (examCam.videoWidth || canvas.width) / 2;
          const deviation = Math.abs(faceCenterX - videoCenterX);
          if(box.width && deviation > box.width * 0.6){
            triggerWarning('Face looks away (center deviation)');
          } else {
            // OK
            clearWarning();
          }
        }
      } else {
        // fallback image diff
        const cur = takeSnapshot(examCam);
        if(!cur){ log('frame capture failed'); return; }
        const ratio = imageDiffRatio(refImage, cur);
        log('monitor ratio:'+ratio.toFixed(3));
        if(ratio > FLAG_THRESHOLD){
          // immediate severe change -> flag
          handleFlag('Significant face change detected (possible different person or major change).');
        } else if(ratio > WARN_THRESHOLD){
          triggerWarning('Face differs from reference (suspicious).');
        } else {
          clearWarning();
        }
      }
    }catch(e){
      console.warn('monitor err', e);
    }
  }, CHECK_INTERVAL);
}

// warning/flag handlers and grace timer
function triggerWarning(reason){
  if(flagged) return;
  log('Warning triggered: ' + reason);
  warnCount++; document.getElementById('warns')?.innerText = warnCount;
  warnMsg.textContent = 'âš ï¸ Warning: Please face camera (strict monitoring).';
  beep(280,880);
  // start grace timer: if not cleared in GRACE_MS -> flag
  if(graceTimer) clearTimeout(graceTimer);
  graceTimer = setTimeout(()=> {
    // recheck quickly once before flagging to avoid transient false positive
    (async ()=>{
      if(flagged) return;
      const cur = takeSnapshot(examCam);
      if(!cur) { handleFlag('No frame during grace'); return; }
      const ratio = imageDiffRatio(refImage, cur);
      log('grace recheck ratio:'+ratio.toFixed(3));
      if(ratio > WARN_THRESHOLD){
        handleFlag('Violation persisted after warning (grace expired).');
      } else {
        // cleared
        clearWarning();
      }
    })();
  }, GRACE_MS);
  // set warning state
  warningGiven = true;
}

function clearWarning(){
  if(warnMsg.textContent) log('Warning cleared');
  warnMsg.textContent = '';
  if(graceTimer) { clearTimeout(graceTimer); graceTimer = null; }
  // don't reset warning count (we keep counts) but remove active warning state
  warningGiven = false;
}

function handleFlag(reason){
  if(flagged) return;
  flagged = true; flagCount++; document.getElementById('flags')?.innerText = flagCount;
  flagMsg.textContent = 'ðŸš« MALPRACTICE: Exam stopped due to suspicious face change.';
  beep(900,320);
  log('FLAGGED: ' + reason);
  // stop timers and monitoring and camera
  if(totalTimerInterval) clearInterval(totalTimerInterval);
  if(sectionTimerInterval) clearInterval(sectionTimerInterval);
  if(monitorInterval) clearInterval(monitorInterval);
  if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); previewStream=null; }
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
  // disable UI
  Array.from(document.querySelectorAll('input[type=radio]')).forEach(i=>i.disabled=true);
  nextBtn.disabled = true; submitBtn.disabled = true;
  // show malpractice result
  showFlaggedResult(reason);
}

// flagged result UI
function showFlaggedResult(reason){
  resultPanel.classList.remove('hidden'); resultPanel.style.display = 'block';
  resultBox.innerHTML = `<div style="font-weight:800;color:var(--danger)">MALPRACTICE DETECTED</div>
    <div style="margin-top:8px">Reason: ${reason}</div>
    <div style="margin-top:8px">You were flagged for violating the strict monitoring rules. Exam has been stopped.</div>`;
  document.getElementById('qbox').style.display = 'none';
}

// compute results (normal end)
function computeAndShowResults(){
  if(flagged){
    showFlaggedResult('Flagged before submit');
    return;
  }
  // stop everything
  if(totalTimerInterval) clearInterval(totalTimerInterval);
  if(sectionTimerInterval) clearInterval(sectionTimerInterval);
  if(monitorInterval) clearInterval(monitorInterval);
  if(examStream){ examStream.getTracks().forEach(t=>t.stop()); examStream=null; }
  // save current selection
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) answers[currentSubject*5 + currentQ] = Number(sel.value);
  // compute per subject and total
  let perSub = [], totalCorrect = 0;
  for(let s=0;s<subjects.length;s++){
    let correct=0;
    for(let q=0;q<5;q++){
      const idx = s*5 + q;
      if(typeof answers[idx] === 'number' && answers[idx] === subjects[s].questions[q].a) correct++;
    }
    perSub.push(correct);
    totalCorrect += correct;
  }
  const totalMarks = totalCorrect * 5;
  let grade = '';
  if(totalMarks >= 80) grade = 'Distinction';
  else if(totalMarks >= 65) grade = 'Upper Class';
  else if(totalMarks >= 50) grade = 'Lower Class';
  else if(totalMarks >= 40) grade = 'Pass';
  else if(totalMarks >= 30) grade = 'Play Class';
  else grade = 'Failed â€” Retry';
  // show results
  let html = `<div style="font-weight:800">Result for ${nameInput.value}</div>`;
  html += `<div style="margin-top:8px">Per-subject:</div><ul>`;
  for(let s=0;s<subjects.length;s++){
    html += `<li>${subjects[s].name}: ${perSub[s]} / 5 (${perSub[s]*5} marks)</li>`;
  }
  html += `</ul><div style="margin-top:8px"><strong>Total: ${totalMarks} / 100</strong></div>`;
  html += `<div style="margin-top:8px"><strong>Grade: ${grade}</strong></div>`;
  resultBox.innerHTML = html;
  resultPanel.classList.remove('hidden'); resultPanel.style.display = 'block';
  document.getElementById('qbox').style.display = 'none';
}

// initial render question (for when exam starts)
function renderQuestion(){ /* defined earlier; placeholder to avoid linter */ }

// reuse earlier renderQuestion definition (duplicated here for clarity)
function renderQuestion(){
  const subj = subjects[currentSubject];
  const q = subj.questions[currentQ];
  qSubject.textContent = subj.name;
  qText.textContent = q.q;
  optionsEl.innerHTML = '';
  q.opts.forEach((opt, idx)=>{
    const id = `opt_${currentSubject}_${currentQ}_${idx}`;
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="opt" id="${id}" value="${idx}"> ${opt}`;
    optionsEl.appendChild(label);
  });
  qProgress.textContent = `Q ${currentQ+1}/5 â€¢ Subject ${currentSubject+1}/${subjects.length}`;
  const filled = answers.filter(a=>a!==null).length;
  const pct = Math.round((filled/20)*100);
  progressFill.style.width = pct + '%';
}

// next button handler (already defined earlier but ensure consistency)
nextBtn.addEventListener('click', ()=>{
  if(flagged) return alert('Exam flagged out â€” cannot continue');
  const sel = document.querySelector('input[name="opt"]:checked');
  const overall = currentSubject*5 + currentQ;
  if(sel) answers[overall] = Number(sel.value);
  if(currentQ < 4){ currentQ++; renderQuestion(); }
  else {
    if(currentSubject < subjects.length -1){
      currentSubject++; currentQ = 0; sectionSeconds = 5*60; renderQuestion();
    } else computeAndShowResults();
  }
});

// retry
retryBtn.addEventListener('click', ()=> location.reload());

// initial log
log('App ready â€” strict monitoring enabled. Enter name and press Proceed.');
</script>
</body>
</html>
